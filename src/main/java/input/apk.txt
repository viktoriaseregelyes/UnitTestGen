import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import android.content.Context;
import android.os.Environment;

import org.junit.jupiter.api.*;
import org.mockito.MockedConstruction;
import org.mockito.MockedStatic;

import java.io.File;
import java.io.IOException;

class APKExpansionSupportTest {

    private Context mockContext;
    private File mockRootDir;
    private File mockExpPath;
    private File mockMainFile;
    private File mockPatchFile;

    private MockedStatic<Environment> envMock;
    private MockedConstruction<ZipResourceFile> zipMockConstruction;

    @BeforeEach
    void setUp() throws IOException {
        // --- Context mock ---
        mockContext = mock(Context.class);
        when(mockContext.getPackageName()).thenReturn("com.example.app");

        // --- File mocks ---
        mockRootDir = mock(File.class);
        when(mockRootDir.toString()).thenReturn("/mocked/root");

        mockExpPath = mock(File.class);
        when(mockExpPath.exists()).thenReturn(true);

        mockMainFile = mock(File.class);
        when(mockMainFile.isFile()).thenReturn(true);

        mockPatchFile = mock(File.class);
        when(mockPatchFile.isFile()).thenReturn(true);

        // --- Static Environment mock ---
        envMock = mockStatic(Environment.class);
        envMock.when(Environment::getExternalStorageState)
               .thenReturn(Environment.MEDIA_MOUNTED);
        envMock.when(Environment::getExternalStorageDirectory)
               .thenReturn(mockRootDir);

        // --- Mock File construction ---
        mockConstruction(File.class, (mock, context) -> {
            String path = String.join(File.separator, context.arguments().stream()
                    .map(Object::toString).toArray(String[]::new));
            // Match path calls
            if (path.equals("/mocked/root/Android/obb/com.example.app")) {
                when(mock.exists()).thenReturn(true);
                when(mock.toString()).thenReturn(path);
            }
            if (path.endsWith("main.1.com.example.app.obb")) {
                when(mock.isFile()).thenReturn(true);
                when(mock.toString()).thenReturn(path);
            }
            if (path.endsWith("patch.2.com.example.app.obb")) {
                when(mock.isFile()).thenReturn(true);
                when(mock.toString()).thenReturn(path);
            }
        });

        // --- Mock ZipResourceFile construction ---
        zipMockConstruction = mockConstruction(ZipResourceFile.class,
                (mock, context) -> when(mock.addPatchFile(anyString())).thenAnswer(inv -> null));
    }

    @AfterEach
    void tearDown() {
        envMock.close();
        zipMockConstruction.close();
    }

    @Test
    void testGetAPKExpansionFiles_ReturnsMainAndPatch() {
        String[] result = APKExpansionSupport.getAPKExpansionFiles(mockContext, 1, 2);

        assertEquals(2, result.length);
        assertTrue(result[0].contains("main.1.com.example.app.obb"));
        assertTrue(result[1].contains("patch.2.com.example.app.obb"));
    }

    @Test
    void testGetResourceZipFile_CallsAddPatchFile() throws IOException {
        String[] files = {"main.1.com.example.app.obb", "patch.2.com.example.app.obb"};

        ZipResourceFile zip = APKExpansionSupport.getResourceZipFile(files);

        assertNotNull(zip);
        verify(zip).addPatchFile("patch.2.com.example.app.obb");
    }
}
